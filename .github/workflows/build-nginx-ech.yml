env:
  NGINX_VERSION: "1.29.4"
  NGINX_TARBALL_PRIMARY: "https://github.com/nginx/nginx/archive/refs/tags/release-1.29.4.tar.gz"
  NGINX_TARBALL_FALLBACK: "https://nginx.org/download/nginx-1.29.4.tar.gz"
  PCRE2_VERSION: "10.47"
  PCRE2_TARBALL: "https://github.com/PCRE2Project/pcre2/releases/download/pcre2-10.47/pcre2-10.47.tar.gz"
  ZLIB_VERSION: "1.3.1"
  ZLIB_TARBALL_PRIMARY: "https://github.com/madler/zlib/archive/refs/tags/v1.3.1.tar.gz"
  ZLIB_TARBALL_FALLBACK: "https://zlib.net/zlib-1.3.1.tar.gz"
  OPENSSL_REPO: "https://github.com/openssl/openssl.git"
  OPENSSL_BASE_TAG: "openssl-3.6.0"
  OPENSSL_BASE_COMMIT: "7b371d80d959ec9ab4139d09d78e83c090de9779"
  OPENSSL_MASTER_REF: "master"
  OPENSSL_ECH_REF: "feature/ech"
  OPENSSL_ECH_COMMIT: "ac3b44faf3bb51592e5d7904168801bc72ae3556"
  NGX_BROTLI_REPO: "https://github.com/google/ngx_brotli.git"
  NGX_BROTLI_REF: "master"
  NGX_BROTLI_COMMIT: "a71f9312c2deb28875acc7bacfdd5695a111aa53"
  PREFIX: "/opt/nginx-ech"
  APT_PACKAGES_BUILD_NGINX: "build-essential ca-certificates ccache cmake git ninja-build perl pkg-config"
  APT_PACKAGES_OPENSSL: "build-essential ca-certificates ccache git perl"
  APT_PACKAGES_TEST: "binutils"
  APT_PACKAGES_ALL: "build-essential ca-certificates ccache cmake git ninja-build perl pkg-config binutils"

name: Build NGINX with ECH support for linux-arm64

on:
  push:
    branches:
      - main
      - develop
      - release
    tags:
      - "r*"

permissions:
  contents: write

jobs:
  init:
    runs-on: ubuntu-24.04
    outputs:
      cache_ts: ${{ steps.ts.outputs.cache_ts }}
    steps:
      - id: ts
        run: echo "cache_ts=$(date -u --iso-8601=seconds)" >> "$GITHUB_OUTPUT"

  check-templates:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Verify templates
        run: python script/tpl.py check

  cache-apt:
    needs: init
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Prepare apt cache dir
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/cache/apt/archives /var/lib/apt/lists/partial
          sudo chown -R "$USER:$USER" /var/cache/apt/archives /var/lib/apt/lists
      - name: Restore apt cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: apt-${{ needs.init.outputs.cache_ts }}
          restore-keys: apt-
      - name: Populate apt cache
        id: prep
        run: |
          set -euxo pipefail
          STAMP_FILE="/var/cache/apt/archives/CACHE-TIMESTAMP.txt"
          LISTS_DIR="/var/lib/apt/lists"
          HAS_LISTS=0
          if find "$LISTS_DIR" -maxdepth 1 -type f ! -name 'lock' -print -quit | grep -q .; then
            HAS_LISTS=1
          fi
          if [ -f "$STAMP_FILE" ] && [ "$HAS_LISTS" -eq 1 ]; then
            STAMP=$(cat "$STAMP_FILE" || true)
            STAMP_EPOCH=$(date -u -d "$STAMP" +%s 2>/dev/null || echo 0)
            NOW=$(date -u +%s)
            if [ "$STAMP_EPOCH" -gt 0 ] && [ $((NOW - STAMP_EPOCH)) -lt 86400 ]; then
              echo "cache_changed=0" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi
          BEFORE_HASH=$(find /var/cache/apt/archives /var/lib/apt/lists -type f -print0 | sort -z | xargs -0 -r sha256sum | sha256sum)
          sudo chown -R root:root /var/cache/apt/archives /var/lib/apt/lists
          sudo apt-get update
          sudo apt-get install -y --download-only $APT_PACKAGES_ALL
          sudo sh -c 'date -u --iso-8601=seconds > /var/cache/apt/archives/CACHE-TIMESTAMP.txt'
          sudo chown -R "$USER:$USER" /var/cache/apt/archives /var/lib/apt/lists
          AFTER_HASH=$(find /var/cache/apt/archives /var/lib/apt/lists -type f -print0 | sort -z | xargs -0 -r sha256sum | sha256sum)
          if [ "$BEFORE_HASH" = "$AFTER_HASH" ]; then
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          fi
      - name: Save apt cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: apt-${{ needs.init.outputs.cache_ts }}

  cache-nginx:
    needs: init
    runs-on: ubuntu-24.04
    steps:
      - name: Restore nginx cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/nginx
          key: nginx-${{ needs.init.outputs.cache_ts }}
          restore-keys: nginx-
      - name: Ensure nginx tarball
        id: prep
        run: |
          set -euxo pipefail
          CACHE_DIR="$HOME/.cache/nginx-ech/nginx"
          mkdir -p "$CACHE_DIR"
          TARBALL="$CACHE_DIR/nginx-${NGINX_VERSION}.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            if ! curl -fL "$NGINX_TARBALL_PRIMARY" -o "$TARBALL"; then
              curl -fL "$NGINX_TARBALL_FALLBACK" -o "$TARBALL"
            fi
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          fi
      - name: Save nginx cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/nginx
          key: nginx-${{ needs.init.outputs.cache_ts }}

  cache-pcre2:
    needs: init
    runs-on: ubuntu-24.04
    steps:
      - name: Restore PCRE2 cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/pcre2
          key: pcre2-${{ needs.init.outputs.cache_ts }}
          restore-keys: pcre2-
      - name: Ensure PCRE2 tarball
        id: prep
        run: |
          set -euxo pipefail
          CACHE_DIR="$HOME/.cache/nginx-ech/pcre2"
          mkdir -p "$CACHE_DIR"
          TARBALL="$CACHE_DIR/pcre2-${PCRE2_VERSION}.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            curl -fL "$PCRE2_TARBALL" -o "$TARBALL"
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          fi
      - name: Save PCRE2 cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/pcre2
          key: pcre2-${{ needs.init.outputs.cache_ts }}

  cache-zlib:
    needs: init
    runs-on: ubuntu-24.04
    steps:
      - name: Restore zlib cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/zlib
          key: zlib-${{ needs.init.outputs.cache_ts }}
          restore-keys: zlib-
      - name: Ensure zlib tarball
        id: prep
        run: |
          set -euxo pipefail
          CACHE_DIR="$HOME/.cache/nginx-ech/zlib"
          mkdir -p "$CACHE_DIR"
          TARBALL="$CACHE_DIR/zlib-${ZLIB_VERSION}.tar.gz"
          if [ ! -f "$TARBALL" ]; then
            if ! curl -fL "$ZLIB_TARBALL_PRIMARY" -o "$TARBALL"; then
              curl -fL "$ZLIB_TARBALL_FALLBACK" -o "$TARBALL"
            fi
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          fi
      - name: Save zlib cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/zlib
          key: zlib-${{ needs.init.outputs.cache_ts }}

  cache-openssl:
    needs: init
    runs-on: ubuntu-24.04
    steps:
      - name: Restore OpenSSL cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/openssl
          key: openssl-${{ needs.init.outputs.cache_ts }}
          restore-keys: openssl-
      - name: Ensure OpenSSL repo
        id: prep
        run: |
          set -euxo pipefail
          CACHE_DIR="$HOME/.cache/nginx-ech/openssl"
          PATCH_STATE="$CACHE_DIR/.ech_patch_state"
          cache_changed=0
          if [ ! -d "$CACHE_DIR/.git" ]; then
            rm -rf "$CACHE_DIR"
            git clone "$OPENSSL_REPO" "$CACHE_DIR"
            cache_changed=1
          fi
          cd "$CACHE_DIR"
          git fetch origin "$OPENSSL_BASE_TAG" "$OPENSSL_MASTER_REF" "$OPENSSL_ECH_REF"
          git cat-file -e "$OPENSSL_BASE_COMMIT^{commit}"
          git cat-file -e "$OPENSSL_ECH_COMMIT^{commit}"

          DESIRED_STATE="${OPENSSL_BASE_COMMIT}:${OPENSSL_ECH_COMMIT}"
          CURRENT_STATE=""
          if [ -f "$PATCH_STATE" ]; then
            CURRENT_STATE=$(cat "$PATCH_STATE")
          fi
          if [ "$CURRENT_STATE" != "$DESIRED_STATE" ]; then
            git checkout "$OPENSSL_BASE_COMMIT"
            BASE_COMMIT=$(git merge-base "origin/$OPENSSL_MASTER_REF" "origin/$OPENSSL_ECH_REF")
            COMMITS=$(git rev-list --reverse "$BASE_COMMIT..$OPENSSL_ECH_COMMIT")
            git config user.name "CI Merge"
            git config user.email "ci@example.invalid"
            for c in $COMMITS; do
              git cherry-pick -X theirs "$c"
            done
            echo "$DESIRED_STATE" > "$PATCH_STATE"
            cache_changed=1
          fi
          echo "cache_changed=$cache_changed" >> "$GITHUB_OUTPUT"
      - name: Save OpenSSL cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/openssl
          key: openssl-${{ needs.init.outputs.cache_ts }}

  cache-ngx-brotli:
    needs: init
    runs-on: ubuntu-24.04
    steps:
      - name: Restore ngx_brotli cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/ngx_brotli
          key: ngx-brotli-${{ needs.init.outputs.cache_ts }}
          restore-keys: ngx-brotli-
      - name: Ensure ngx_brotli repo
        id: prep
        run: |
          set -euxo pipefail
          CACHE_DIR="$HOME/.cache/nginx-ech/ngx_brotli"
          cache_changed=0
          if [ ! -d "$CACHE_DIR/.git" ]; then
            rm -rf "$CACHE_DIR"
            git clone "$NGX_BROTLI_REPO" "$CACHE_DIR"
            cache_changed=1
          fi
          cd "$CACHE_DIR"
          if ! git cat-file -e "$NGX_BROTLI_COMMIT^{commit}"; then
            git fetch origin "$NGX_BROTLI_REF"
            cache_changed=1
          fi
          echo "cache_changed=$cache_changed" >> "$GITHUB_OUTPUT"
      - name: Save ngx_brotli cache
        if: steps.prep.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/ngx_brotli
          key: ngx-brotli-${{ needs.init.outputs.cache_ts }}

  build-nginx:
    needs:
      - init
      - cache-apt
      - cache-nginx
      - cache-pcre2
      - cache-zlib
      - cache-openssl
      - cache-ngx-brotli
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare apt cache dir
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/cache/apt/archives /var/lib/apt/lists/partial
          sudo chown -R "$USER:$USER" /var/cache/apt/archives /var/lib/apt/lists
      - name: Restore apt cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: apt-${{ needs.init.outputs.cache_ts }}
          restore-keys: apt-
      - name: Install build dependencies
        run: |
          set -euxo pipefail
          sudo chown -R root:root /var/cache/apt/archives /var/lib/apt/lists
          sudo apt-get install -y $APT_PACKAGES_BUILD_NGINX
      - name: Restore build input caches
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/nginx
          key: nginx-${{ needs.init.outputs.cache_ts }}
          restore-keys: nginx-
      - name: Restore PCRE2 cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/pcre2
          key: pcre2-${{ needs.init.outputs.cache_ts }}
          restore-keys: pcre2-
      - name: Restore zlib cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/zlib
          key: zlib-${{ needs.init.outputs.cache_ts }}
          restore-keys: zlib-
      - name: Restore OpenSSL cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/openssl
          key: openssl-${{ needs.init.outputs.cache_ts }}
          restore-keys: openssl-
      - name: Restore ngx_brotli cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/ngx_brotli
          key: ngx-brotli-${{ needs.init.outputs.cache_ts }}
          restore-keys: ngx-brotli-
      - name: Restore ccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/ccache
          key: ccache-${{ needs.init.outputs.cache_ts }}
          restore-keys: ccache-
      - name: Record ccache hash (before build)
        run: |
          set -euxo pipefail
          CCACHE_DIR="$HOME/.cache/nginx-ech/ccache"
          HASH_DIR="$HOME/.cache/nginx-ech/ccache-hash"
          mkdir -p "$CCACHE_DIR" "$HASH_DIR"
          find "$CCACHE_DIR" -type f \
            ! -name stats \
            ! -name stats.lock \
            ! -path "$CCACHE_DIR/tmp/*" \
            -print0 | sort -z | xargs -0 -r sha256sum | sha256sum > "$HASH_DIR/ccache.hash.before"

      - name: Build nginx and package
        run: bash script/build_nginx.sh
        id: package
      - name: Upload nginx artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-ech-arm64
          path: ${{ steps.package.outputs.tar_path }}
      - name: Upload nginx release asset
        if: startsWith(github.ref, 'refs/tags/r')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: ${{ steps.package.outputs.tar_path }}
      - name: Decide whether to save ccache
        if: always()
        id: ccache
        run: |
          set -euxo pipefail
          CCACHE_DIR="$HOME/.cache/nginx-ech/ccache"
          HASH_DIR="$HOME/.cache/nginx-ech/ccache-hash"
          BEFORE_HASH=""
          if [ -f "$HASH_DIR/ccache.hash.before" ]; then
            BEFORE_HASH=$(cat "$HASH_DIR/ccache.hash.before")
          fi
          AFTER_HASH=$(find "$CCACHE_DIR" -type f \
            ! -name stats \
            ! -name stats.lock \
            ! -path "$CCACHE_DIR/tmp/*" \
            -print0 | sort -z | xargs -0 -r sha256sum | sha256sum)
          mkdir -p "$HASH_DIR"
          echo "$AFTER_HASH" > "$HASH_DIR/ccache.hash.after"
          if [ "$BEFORE_HASH" = "$AFTER_HASH" ]; then
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          fi
      - name: Save ccache cache
        if: always() && steps.ccache.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/ccache
          key: ccache-${{ needs.init.outputs.cache_ts }}

  build-deb:
    needs:
      - build-nginx
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download nginx artifact
        uses: actions/download-artifact@v4
        with:
          name: nginx-ech-arm64
      - name: Build deb package
        run: bash script/build_deb.sh
      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: nginx-ech-deb
          path: nginx-ech_*_arm64.deb
      - name: Upload deb release asset
        if: startsWith(github.ref, 'refs/tags/r')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          files: nginx-ech_*_arm64.deb

  build-openssl-cli:
    needs:
      - init
      - cache-apt
      - cache-openssl
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare apt cache dir
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/cache/apt/archives /var/lib/apt/lists/partial
          sudo chown -R "$USER:$USER" /var/cache/apt/archives /var/lib/apt/lists
      - name: Restore apt cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: apt-${{ needs.init.outputs.cache_ts }}
          restore-keys: apt-
      - name: Install build dependencies
        run: |
          set -euxo pipefail
          sudo chown -R root:root /var/cache/apt/archives /var/lib/apt/lists
          sudo apt-get install -y $APT_PACKAGES_OPENSSL
      - name: Restore OpenSSL cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/openssl
          key: openssl-${{ needs.init.outputs.cache_ts }}
          restore-keys: openssl-
      - name: Restore OpenSSL ccache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/nginx-ech/ccache-openssl
          key: ccache-openssl-${{ needs.init.outputs.cache_ts }}
          restore-keys: ccache-openssl-
      - name: Record OpenSSL ccache hash (before build)
        run: |
          set -euxo pipefail
          CCACHE_DIR="$HOME/.cache/nginx-ech/ccache-openssl"
          HASH_DIR="$HOME/.cache/nginx-ech/ccache-openssl-hash"
          mkdir -p "$CCACHE_DIR" "$HASH_DIR"
          find "$CCACHE_DIR" -type f \
            ! -name stats \
            ! -name stats.lock \
            ! -path "$CCACHE_DIR/tmp/*" \
            -print0 | sort -z | xargs -0 -r sha256sum | sha256sum > "$HASH_DIR/ccache.hash.before"
      - name: Build OpenSSL CLI
        run: bash script/build_openssl_cli.sh
        id: package
      - name: Decide whether to save OpenSSL ccache
        if: always()
        id: ccache
        run: |
          set -euxo pipefail
          CCACHE_DIR="$HOME/.cache/nginx-ech/ccache-openssl"
          HASH_DIR="$HOME/.cache/nginx-ech/ccache-openssl-hash"
          BEFORE_HASH=""
          if [ -f "$HASH_DIR/ccache.hash.before" ]; then
            BEFORE_HASH=$(cat "$HASH_DIR/ccache.hash.before")
          fi
          AFTER_HASH=$(find "$CCACHE_DIR" -type f \
            ! -name stats \
            ! -name stats.lock \
            ! -path "$CCACHE_DIR/tmp/*" \
            -print0 | sort -z | xargs -0 -r sha256sum | sha256sum)
          mkdir -p "$HASH_DIR"
          echo "$AFTER_HASH" > "$HASH_DIR/ccache.hash.after"
          if [ "$BEFORE_HASH" = "$AFTER_HASH" ]; then
            echo "cache_changed=0" >> "$GITHUB_OUTPUT"
          else
            echo "cache_changed=1" >> "$GITHUB_OUTPUT"
          fi
      - name: Save OpenSSL ccache
        if: always() && steps.ccache.outputs.cache_changed == '1'
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/nginx-ech/ccache-openssl
          key: ccache-openssl-${{ needs.init.outputs.cache_ts }}
      - name: Upload OpenSSL CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-openssl-cli
          path: ${{ steps.package.outputs.tar_path }}

  test-ech:
    needs:
      - cache-apt
      - build-nginx
      - build-openssl-cli
    runs-on: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Prepare apt cache dir
        run: |
          set -euxo pipefail
          sudo mkdir -p /var/cache/apt/archives /var/lib/apt/lists/partial
          sudo chown -R "$USER:$USER" /var/cache/apt/archives /var/lib/apt/lists
      - name: Restore apt cache
        uses: actions/cache/restore@v4
        with:
          path: |
            /var/cache/apt/archives
            /var/lib/apt/lists
          key: apt-${{ needs.init.outputs.cache_ts }}
          restore-keys: apt-
      - name: Install test dependencies
        run: |
          set -euxo pipefail
          sudo chown -R root:root /var/cache/apt/archives /var/lib/apt/lists
          sudo apt-get install -y $APT_PACKAGES_TEST
      - name: Download nginx artifact
        uses: actions/download-artifact@v4
        with:
          name: nginx-ech-arm64
      - name: Download OpenSSL CLI artifact
        uses: actions/download-artifact@v4
        with:
          name: test-openssl-cli
      - name: Extract artifacts
        run: |
          set -euxo pipefail
          tar -xzf nginx-*.tar.gz
          mkdir -p test-openssl
          tar -xzf test-openssl-cli.tar.gz -C test-openssl
      - name: glibc check
        run: |
          set -euxo pipefail
          ldd --version
          readelf --version-info ./opt/nginx-ech/sbin/nginx | grep -o 'GLIBC_[0-9.]*' | sort -u
      - name: Run ECH smoke tests
        run: bash script/test_ech.sh
